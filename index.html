<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rabo Hotel - v16 Multiplayer Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700;900&display=swap');

        body {
            margin: 0; overflow: hidden; background-color: #050510;
            font-family: 'Roboto', sans-serif; touch-action: none; user-select: none;
        }
        canvas { display: block; image-rendering: pixelated; }

        /* LOADING SCREEN */
        #loading-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #050510; z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: #ff0055;
            font-family: 'Press Start 2P', cursive; text-align: center;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #330011; border-top: 4px solid #ff0055;
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* UI LAYER */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 20;
        }

        /* Top HUD */
        .hud-top {
            padding: 15px; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); pointer-events: auto;
            display: flex; justify-content: space-between; align-items: flex-start;
        }
        .logo { 
            font-family: 'Press Start 2P', cursive; color: #ff0055; 
            text-shadow: 2px 2px 0px #330011, -1px -1px 0px #ffaad4; 
            font-size: 12px; line-height: 1.5; transform: skew(-5deg);
        }
        
        .btn-style {
            background: linear-gradient(135deg, #cc0044, #660022); border: 2px solid #ff0066; color: white;
            padding: 8px 12px; border-radius: 8px; font-weight: bold; font-size: 10px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(200,0,50,0.4); text-transform: uppercase; display: flex; align-items: center; gap: 5px;
            transition: transform 0.1s;
        }
        .btn-style:active { transform: scale(0.95); }
        .btn-music { border-color: #00ff00; color: #ccffcc; background: linear-gradient(135deg, #004400, #002200); }

        /* Invite Modal */
        #invite-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(20, 0, 10, 0.95); border: 2px solid #ff0055; padding: 20px;
            border-radius: 15px; text-align: center; display: none; z-index: 2000;
            box-shadow: 0 0 50px rgba(255,0,85,0.6); animation: bounceIn 0.3s;
            pointer-events: auto; width: 280px;
        }
        .modal-title { color: #ff0055; font-weight: 900; margin-bottom: 10px; font-size: 14px; }
        .modal-text { color: #fff; margin-bottom: 20px; font-size: 12px; }
        .modal-btn { 
            padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; display: inline-block; margin: 5px;
        }
        .btn-accept { background: #00ff00; color: #000; }
        .btn-deny { background: #ff0000; color: #fff; }

        /* Context Actions */
        .ctx-container {
            position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 10px; pointer-events: auto; z-index: 50;
        }
        .ctx-btn {
            background: rgba(0,0,0,0.9); border: 2px solid #fff; color: white; padding: 10px 20px;
            border-radius: 50px; font-weight: 900; font-size: 12px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 8px;
            animation: bounceIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-transform: uppercase;
        }
        .ctx-btn:hover { transform: scale(1.1); }
        .ctx-btn.red { border-color: #ff0044; color: #ff0044; }
        .ctx-btn.blue { border-color: #00ffff; color: #00ffff; }

        @keyframes bounceIn { from { transform: translate(-50%, -50%) scale(0); } to { transform: translate(-50%, -50%) scale(1); } }

        /* Menus */
        #interact-menu, #emote-menu, #music-menu {
            position: absolute; background: rgba(20, 10, 20, 0.98); border: 2px solid #ff0055;
            padding: 10px; border-radius: 12px; display: none; flex-direction: column; gap: 8px;
            pointer-events: auto; z-index: 100; box-shadow: 0 0 30px rgba(255,0,85,0.4);
        }
        
        #emote-menu { 
            flex-direction: row; flex-wrap: wrap; width: 220px; bottom: 85px; left: 50%; 
            transform: translateX(-50%); display: none; justify-content: center;
        }
        #emote-menu.visible { display: flex; }
        
        #music-menu {
            top: 50%; left: 50%; transform: translate(-50%, -50%); width: 300px;
        }

        .int-btn {
            background: #440022; color: #ffccdd; padding: 10px 12px; border-radius: 6px; 
            cursor: pointer; font-size: 10px; font-weight: bold; display: flex; align-items: center; gap: 8px;
            transition: 0.2s; border: 1px solid #660033; justify-content: center;
        }
        .int-btn:hover { background: #880044; color: white; border-color: #ff0066; }
        
        .emote-opt { font-size: 24px; cursor: pointer; padding: 5px; transition: transform 0.2s; }
        .emote-opt:hover { transform: scale(1.3); }

        /* Custom Panel */
        #custom-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(15, 15, 30, 0.98); border: 2px solid #ff0066; padding: 20px; border-radius: 16px;
            pointer-events: auto; display: none; width: 340px; max-height: 85vh; overflow-y: auto;
            box-shadow: 0 0 50px rgba(255,0,100,0.3); backdrop-filter: blur(15px); z-index: 1000;
        }
        #custom-panel.open { display: block; }

        .section-header { color: #ff88aa; font-size: 10px; font-weight: bold; margin-bottom: 8px; border-bottom: 1px solid #662244; padding-bottom: 4px; letter-spacing: 1px; margin-top: 15px; }
        .skin-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; }
        .skin-opt { width: 100%; aspect-ratio: 1; border-radius: 50%; border: 3px solid #442233; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .skin-opt.selected { border-color: #ff0066; box-shadow: 0 0 15px #ff0066; }

        .acc-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .acc-btn { 
            background: #331122; border: 1px solid #552233; color: #ffccdd; padding: 8px; 
            border-radius: 8px; font-size: 10px; text-align: center; cursor: pointer; transition: 0.2s;
        }
        .acc-btn.selected { background: #ff0055; color: white; border-color: white; box-shadow: 0 0 10px #ff0055; }

        .input-dark {
            width: 100%; background: #1a0a10; border: 1px solid #663344; color: white; padding: 10px;
            border-radius: 8px; font-family: 'Roboto', sans-serif; font-weight: bold; outline: none; margin-bottom: 10px;
        }
        .input-dark:focus { border-color: #ff0066; }

        /* Chat & Bottom */
        .hud-bottom {
            padding: 15px; pointer-events: auto; background: linear-gradient(to top, #000 0%, transparent 100%);
            display: flex; gap: 10px; align-items: center;
        }
        #chat-input {
            flex: 1; background: rgba(255,255,255,0.1); border: 1px solid #444; border-radius: 30px; padding: 12px 20px;
            color: white; font-weight: bold; outline: none; backdrop-filter: blur(5px);
        }
        #chat-input:focus { background: rgba(0,0,0,0.8); border-color: #ff0066; }
        
        .icon-btn { background: #222; color: #fff; border: 1px solid #444; padding: 12px; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .icon-btn:hover { background: #444; border-color: #fff; }
        #btn-send { background: #ff0066; color: #fff; border: none; font-weight: bold; box-shadow: 0 0 10px #ff0066; }
        
        /* Toast */
        #toast {
            position: absolute; top: 120px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); border: 1px solid #ff0066; color: #ffaad4;
            padding: 12px 30px; border-radius: 50px; font-weight: 900; font-size: 12px;
            display: none; animation: slideDown 0.3s; z-index: 50; text-align: center;
        }
        @keyframes slideDown { from { transform: translate(-50%, -20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        /* Audio Indicator */
        #audio-status {
            position: fixed; top: 60px; right: 15px; background: rgba(0,0,0,0.7); 
            padding: 5px 10px; border-radius: 5px; color: #0f0; font-size: 10px; display: none; z-index: 99;
        }

        #youtube-player { position: absolute; top: -9999px; left: -9999px; opacity: 0; pointer-events: none; }
        
        .room-indicator {
            position: absolute; top: 60px; left: 15px; background: rgba(0,0,0,0.7);
            padding: 5px 10px; border-radius: 5px; color: #ff0066; font-weight: bold; font-size: 10px;
            border: 1px solid #ff0066; display: none;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="spinner"></div>
        <div>Conectando ao Rabo Hotel...</div>
    </div>

    <div id="youtube-player"></div>

    <div id="ui-layer">
        <div class="hud-top">
            <div>
                <div class="logo">üè© RABO MOTEL <span style="font-size:8px; color:#fff;">V16</span></div>
                <div style="font-size:9px; color:#ff88aa; margin-top:2px;">MULTIPLAYER FIX</div>
            </div>
            <div style="display:flex; gap:10px;">
                <button id="btn-audio-init" class="btn-style btn-music"><i class="fas fa-volume-up"></i> SOM</button>
                <button id="btn-dj" class="btn-style"><i class="fas fa-headphones"></i> DJ</button>
                <button id="btn-custom" class="btn-style"><i class="fas fa-user-edit"></i> LOOK</button>
            </div>
        </div>

        <div id="toast"></div>
        <div id="room-indicator" class="room-indicator">SU√çTE PRIVADA</div>
        <div id="audio-status"><i class="fas fa-music"></i> Tocando...</div>
        
        <div id="invite-modal">
            <div class="modal-title">üî• CONVITE üî•</div>
            <div id="invite-text" class="modal-text">Algu√©m quer te levar pro quarto...</div>
            <div class="modal-btn btn-accept" id="btn-accept-invite">VAMOS! (ACEITAR)</div>
            <div class="modal-btn btn-deny" id="btn-deny-invite">T√î FORA (RECUSAR)</div>
        </div>

        <div class="ctx-container" id="ctx-ui"></div>

        <!-- Emote Menu -->
        <div id="emote-menu">
            <div class="emote-opt" onclick="sendEmote('‚ù§Ô∏è')">‚ù§Ô∏è</div>
            <div class="emote-opt" onclick="sendEmote('üî•')">üî•</div>
            <div class="emote-opt" onclick="sendEmote('üíã')">üíã</div>
            <div class="emote-opt" onclick="sendEmote('üòà')">üòà</div>
            <div class="emote-opt" onclick="sendEmote('üçÜ')">üçÜ</div>
            <div class="emote-opt" onclick="sendEmote('üçë')">üçë</div>
            <div class="emote-opt" onclick="sendEmote('üí¶')">üí¶</div>
            <div class="emote-opt" onclick="sendEmote('üç∫')">üç∫</div>
            <div class="emote-opt" onclick="sendEmote('üíä')">üíä</div>
            <div class="emote-opt" onclick="sendEmote('üö¨')">üö¨</div>
        </div>

        <!-- Music Menu -->
        <div id="music-menu">
            <div class="section-header" style="margin-top:0;">COLOCAR M√öSICA (YOUTUBE)</div>
            <input type="text" id="music-input" class="input-dark" placeholder="Cole link do YouTube...">
            <div class="int-btn" onclick="startDJ()">TOCAR</div>
            <div class="int-btn" style="background:#441111; margin-top:5px;" onclick="stopDJ()">PARAR</div>
            <div class="int-btn" style="background:transparent; border:none; margin-top:5px;" onclick="document.getElementById('music-menu').style.display='none'">CANCELAR</div>
        </div>

        <!-- Menu de Intera√ß√£o -->
        <div id="interact-menu">
            <div class="int-btn" style="border: 2px solid #ff0066; background: #330011; color: #fff;" onclick="sendInvite()">üíå CONVIDAR P/ QUARTO</div>
            <div class="int-btn" onclick="triggerInteract('carry')">üí™ CARREGAR</div>
            <div class="int-btn" onclick="triggerInteract('kiss')">üíã BEIJAR</div>
            <div class="int-btn" onclick="triggerInteract('sarrar')">üî• SARRAR</div>
            <div class="int-btn" onclick="triggerInteract('slap')">üëã TAPA</div>
            <div class="int-btn" style="border-top:1px solid #444; margin-top:5px; background:transparent;" onclick="closeMenu()">FECHAR</div>
        </div>

        <div class="hud-bottom">
            <button id="btn-emote" class="icon-btn"><i class="fas fa-smile"></i></button>
            <input type="text" id="chat-input" placeholder="Conversar..." maxlength="50" autocomplete="off">
            <button id="btn-send" class="icon-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <!-- PAINEL LOOK -->
    <div id="custom-panel">
        <div class="section-header" style="margin-top:0;">SEU NOME</div>
        <input type="text" id="input-name" class="input-dark" placeholder="Seu nick..." maxlength="12">

        <div class="section-header">PELE</div>
        <div class="skin-grid" id="skin-grid"></div>
        
        <div class="section-header">ROUPAS & EXTRAS</div>
        <div class="acc-grid" id="acc-grid"></div>

        <button id="btn-save" class="w-full mt-6 bg-purple-600 text-white font-bold p-3 rounded-xl hover:bg-purple-500 shadow-lg transition">SALVAR</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'rabo-hotel-v16'; // Fallback ID if env missing
        const PLAYERS_COLLECTION = "players_v16";
        const WORLD_COLLECTION = "world_v16";

        const TILE_W = 64;
        const TILE_H = 32;
        const MAP_SIZE = 32; 

        // TILES IDs
        const T = { 
            FLOOR_LOBBY: 0, FLOOR_WOOD: 1, FLOOR_DISCO: 2, FLOOR_POOL: 3, FLOOR_SUITE: 4,
            WALL: 10, BAR_COUNTER: 11, BAR_SHELF: 12, DJ_BOOTH: 13, POOL_WATER: 14,
            PLANT: 15, RUG_RED: 16,
            SEAT_BASIC: 20, SOFA: 21, BED: 22, BED_ROUND: 23, JACUZZI: 24
        };

        const C = {
            lobbyA: '#aaaaaa', lobbyB: '#999999',
            woodA: '#2c1a12', woodB: '#1a0f0a', 
            discoA: '#220044', discoB: '#440088',
            suiteA: '#440011', suiteB: '#330000', 
            poolTile: '#eeeeff', 
            wallTop: '#555577', wallSide: '#333355',
            highlight: 'rgba(255, 0, 100, 0.3)'
        };

        // STATE
        let myUserId = null;
        let myPlayerRef = null;
        let players = {};
        let particles = [];
        let offset = { x: 0, y: 0 };
        let hoveredTile = { x: -1, y: -1 };
        let selectedTargetId = null;
        let discoTick = 0;
        let drunkLevel = 0;
        let isDancingLocal = false;
        let ytPlayer = null;
        let currentDJId = null;
        let audioEnabled = false;
        let gameReady = false; // Prevents render crash
        
        let currentRoom = 'lobby'; 
        let motelMode = false;
        let lastInviteFrom = null;

        let soccerBall = { x: 16, y: 16, vx: 0, vy: 0, lastSync: 0 };
        let ballRef = null;

        // AUTH & INIT
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth failed:", error);
                document.getElementById('loading-screen').innerHTML = "<div style='color:red'>Erro de Conex√£o. Recarregue.</div>";
            }
        };
        initAuth();

        onAuthStateChanged(auth, async (u) => {
            if(u) {
                myUserId = u.uid;
                // STRICT PATH RULE
                myPlayerRef = doc(db, 'artifacts', appId, 'public', 'data', PLAYERS_COLLECTION, myUserId);
                ballRef = doc(db, 'artifacts', appId, 'public', 'data', WORLD_COLLECTION, 'ball');

                // Force initial player state to avoid "limbo"
                await setDoc(myPlayerRef, { 
                    x: 8, y: 8, 
                    visualX: 8, visualY: 8, // Crucial for camera
                    room: 'lobby', 
                    lastActive: Date.now(),
                    nick: 'Visitante'
                }, {merge:true});

                // Heartbeat
                setInterval(() => { 
                    if(myPlayerRef) updateDoc(myPlayerRef, { lastActive: Date.now() }).catch(()=>{}); 
                }, 5000);
                
                // Players Listener with Error Handling
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', PLAYERS_COLLECTION), (snap) => {
                    const now = Date.now();
                    const foundIds = [];
                    snap.forEach(d => {
                        const dt = d.data();
                        if(now - (dt.lastActive||0) > 120000) return; // 2 min timeout
                        foundIds.push(d.id);
                        
                        if(!players[d.id]) { 
                            players[d.id] = new Player(d.id, dt); 
                        } else { 
                            players[d.id].sync(dt); 
                        }
                    });
                    
                    // Cleanup
                    Object.keys(players).forEach(k => { if(!foundIds.includes(k)) delete players[k]; });

                    // Only remove loading screen if I am in the list
                    if (players[myUserId]) {
                        gameReady = true;
                        document.getElementById('loading-screen').style.display = 'none';
                    }
                }, (error) => {
                    console.error("Snapshot Error:", error);
                });

                // Ball Sync
                onSnapshot(ballRef, (snap) => {
                    if(snap.exists()) {
                        const d = snap.data();
                        if (Date.now() - (d.t || 0) < 200) { // Only sync if fresh kick
                             soccerBall.x = d.x; soccerBall.y = d.y; soccerBall.vx = d.vx || 0; soccerBall.vy = d.vy || 0;
                        }
                    } else setDoc(ballRef, { x: 16, y: 16 });
                });
            }
        });

        // --- MAP GENERATION ---
        const map = new Array(MAP_SIZE).fill(0).map(() => new Array(MAP_SIZE).fill(0));
        
        function initMap() {
            for(let y=0; y<MAP_SIZE; y++) for(let x=0; x<MAP_SIZE; x++) map[y][x] = T.FLOOR_LOBBY; 
            if (currentRoom === 'lobby') generateLobbyMap(); else generateSuiteMap();
        }

        function generateLobbyMap() {
            for(let y=0; y<MAP_SIZE; y++) for(let x=0; x<MAP_SIZE; x++) {
                if (x===0 || y===0 || x===MAP_SIZE-1 || y===MAP_SIZE-1) { map[y][x] = T.WALL; continue; }
                if (x < 16 && y >= 14) { // Bar
                    map[y][x] = T.FLOOR_WOOD;
                    if(x===15 && y < 22) map[y][x] = T.WALL;
                    if(x===1 && y>=18 && y<=24) map[y][x] = T.BAR_SHELF; 
                    if(x===3 && y>=18 && y<=24) map[y][x] = T.BAR_COUNTER; 
                    if(x===4 && y>=18 && y<=24) map[y][x] = T.SEAT_BASIC; 
                    if(x>=8 && y>=25) map[y][x] = T.SOFA; 
                }
                else if (x < 16 && y < 14) { // Lobby
                    map[y][x] = T.FLOOR_LOBBY;
                    if(y===13 && x!==8) map[y][x] = T.WALL; 
                    if(x===15 && y!==6) map[y][x] = T.WALL;
                    if(y===2 && x>=6 && x<=10) map[y][x] = T.BAR_COUNTER; 
                    if(x>=7 && x<=9 && y>=7 && y<=10) map[y][x] = T.RUG_RED; 
                    if(x===1 && y===1) map[y][x] = T.PLANT;
                }
                else if (x >= 16 && y < 16) { // Disco
                    map[y][x] = T.FLOOR_DISCO;
                    if(y===15 && x!==24) map[y][x] = T.WALL;
                    if(y===2 && x>=22 && x<=26) map[y][x] = T.DJ_BOOTH;
                    if(x>=20 && x<=28 && y>=6 && y<=12) map[y][x] = T.FLOOR_DISCO;
                }
                else { // Pool
                    map[y][x] = T.FLOOR_POOL;
                    if(x>=20 && x<=28 && y>=20 && y<=28) map[y][x] = T.POOL_WATER;
                    if(x>=28 && y>=17 && y<=18) map[y][x] = T.BED;
                }
            }
        }

        function generateSuiteMap() {
            for(let y=0; y<MAP_SIZE; y++) for(let x=0; x<MAP_SIZE; x++) {
                if (x===0 || y===0 || x===MAP_SIZE-1 || y===MAP_SIZE-1) { map[y][x] = T.WALL; continue; }
                map[y][x] = T.FLOOR_SUITE;
                if (x < 8 || x > 24 || y < 8 || y > 24) { map[y][x] = T.WALL; continue; }
                if (x>=15 && x<=17 && y>=15 && y<=17) map[y][x] = T.BED_ROUND;
                if (x>=20 && x<=22 && y>=10 && y<=12) map[y][x] = T.JACUZZI;
                if (x===9 && y===9) map[y][x] = T.PLANT;
                if (x===23 && y===9) map[y][x] = T.PLANT;
            }
        }
        initMap();

        function gridToScreen(gx, gy) {
            return {
                x: (gx - gy) * (TILE_W / 2) + offset.x,
                y: (gx + gy) * (TILE_H / 2) + offset.y
            };
        }
        function screenToGrid(sx, sy) {
            const adjX = sx - offset.x;
            const adjY = sy - offset.y;
            return {
                x: Math.floor((adjY / (TILE_H/2) + adjX / (TILE_W/2)) / 2),
                y: Math.floor((adjY / (TILE_H/2) - adjX / (TILE_W/2)) / 2)
            };
        }

        // --- ROOM LOGIC ---
        window.switchRoom = async (roomId) => {
            currentRoom = roomId;
            initMap();
            const me = players[myUserId];
            if (me) {
                if (roomId === 'lobby') { me.gridX = 8; me.gridY = 8; }
                else { me.gridX = 16; me.gridY = 20; }
                me.visualX = me.gridX; me.visualY = me.gridY;
                if(myPlayerRef) await updateDoc(myPlayerRef, { room: roomId, x: me.gridX, y: me.gridY });
            }
            document.getElementById('room-indicator').style.display = currentRoom==='lobby'?'none':'block';
            document.getElementById('room-indicator').innerText = currentRoom==='lobby'?'':(currentRoom===`suite_${myUserId}`?'MINHA SU√çTE':'SU√çTE PRIVADA');
            showToast(currentRoom === 'lobby' ? "Lobby Principal" : "üî• Su√≠te Privada üî•");
        };

        window.sendInvite = async () => {
            document.getElementById('interact-menu').style.display = 'none';
            if(!selectedTargetId) return;
            const targetRef = doc(db, 'artifacts', appId, 'public', 'data', PLAYERS_COLLECTION, selectedTargetId);
            await updateDoc(targetRef, { inviteFrom: myUserId, inviteTime: Date.now() }).catch(e => console.log(e));
            showToast("Convite enviado! üíå");
            if(currentRoom !== `suite_${myUserId}`) switchRoom(`suite_${myUserId}`);
        };

        document.getElementById('btn-accept-invite').onclick = async () => {
            document.getElementById('invite-modal').style.display = 'none';
            if(lastInviteFrom) { switchRoom(`suite_${lastInviteFrom}`); showToast("Entrando..."); }
        };
        document.getElementById('btn-deny-invite').onclick = () => document.getElementById('invite-modal').style.display = 'none';

        // --- YOUTUBE ---
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        window.onYouTubeIframeAPIReady = function() {
            ytPlayer = new YT.Player('youtube-player', { height: '1', width: '1', videoId: '' });
        };
        
        // --- PLAYER ---
        class Player {
            constructor(id, data) {
                this.id = id;
                this.gridX = data.x || 8; this.gridY = data.y || 8;
                this.visualX = this.gridX; this.visualY = this.gridY;
                this.inPool = false; 
                this.room = data.room || 'lobby';
                this.sync(data);
                this.danceOffset = 0;
            }
            sync(data) {
                this.nick = data.nick || 'Visitante';
                this.skin = data.skin || '#fcbcb8';
                this.acc = data.acc || 'none';
                this.musicId = data.musicId || null;
                this.carrying = data.carrying || null;
                this.diving = data.diving || false;
                this.room = data.room || 'lobby';
                this.isAdmin = (this.nick.toUpperCase().includes('ADMIN') || this.nick.toUpperCase().includes('MOD'));
                
                if(this.id === myUserId && data.inviteFrom && data.inviteTime > (this.lastInviteCheck || 0)) {
                    this.lastInviteCheck = Date.now();
                    if (Date.now() - data.inviteTime < 10000) {
                        lastInviteFrom = data.inviteFrom;
                        const inviterName = players[lastInviteFrom]?.nick || "Algu√©m";
                        document.getElementById('invite-text').innerText = `${inviterName} te chamou pro abate. Aceitas?`;
                        document.getElementById('invite-modal').style.display = 'block';
                    }
                }

                if(this.id !== myUserId) {
                    this.gridX = data.x; this.gridY = data.y;
                    this.dancing = data.dancing || false;
                    this.drink = data.drink || false;
                    this.sitting = data.sitting || false;
                } else {
                    if(Math.abs(data.x - this.gridX) > 5) { this.gridX = data.x; this.gridY = data.y; }
                }
                if (data.chatId && data.chatId !== this.lcid) {
                    this.msg = data.msg; this.lcid = data.chatId; this.mt = 300;
                }
                if (data.emoteId && data.emoteId !== this.leid) {
                    this.leid = data.emoteId; this.playEmote(data.emote);
                }
                if (data.lastInt && data.lastInt > (this.lastIntTime || 0)) {
                    this.lastIntTime = data.lastInt; this.playInteraction(data.intType);
                }
            }
            playInteraction(type) {
                const s = gridToScreen(this.visualX, this.visualY);
                let emoji = type==='kiss'?'üíã':(type==='sarrar'?'üî•':(type==='slap'?'üëã':'üí™'));
                if(type === 'obaoba') emoji = 'üíï';
                for(let i=0; i<8; i++) particles.push({ x:s.x, y:s.y-40, vx:(Math.random()-0.5)*3, vy:-Math.random()*3-1, char:emoji, life:60, c:'#fff' });
                if(type === 'obaoba') {
                    const shakeInt = setInterval(()=>{ offset.x+=(Math.random()-0.5)*10; offset.y+=(Math.random()-0.5)*10; }, 16);
                    setTimeout(()=>clearInterval(shakeInt), 500);
                }
            }
            playEmote(emoji) {
                const s = gridToScreen(this.visualX, this.visualY);
                particles.push({ x:s.x, y:s.y-60, vx:0, vy:-0.5, char:emoji, life:100, c:'#fff', scale: 2 });
                if(emoji === 'ü§Æ') for(let i=0; i<20; i++) particles.push({ x:s.x, y:s.y-20, vx:(Math.random()-0.5)*2, vy:Math.random()*3, char:'.', life:50, c:'#0f0' });
            }
            update() {
                if(this.room !== currentRoom) return;
                
                // Safety catch for visual drift
                if (isNaN(this.visualX) || isNaN(this.visualY)) {
                    this.visualX = this.gridX; this.visualY = this.gridY;
                }

                const currentTile = map[Math.round(this.visualY)]?.[Math.round(this.visualX)];
                const wasInPool = this.inPool;
                this.inPool = (currentTile === T.POOL_WATER || currentTile === T.JACUZZI);
                
                if (this.inPool !== wasInPool) {
                    const s = gridToScreen(this.visualX, this.visualY);
                     for(let i=0; i<5; i++) particles.push({ x:s.x, y:s.y, vx:(Math.random()-0.5)*3, vy:Math.random()*-2, char:'üíß', life:40, c:'#0ff', scale:0.5 });
                }

                let carrier = null;
                Object.values(players).forEach(p => { if(p.carrying === this.id) carrier = p; });
                if(carrier) {
                    this.gridX = carrier.gridX; this.gridY = carrier.gridY;
                    this.visualX = carrier.visualX; this.visualY = carrier.visualY;
                    if(this.room !== carrier.room) this.room = carrier.room; 
                    this.elevation = 15;
                } else {
                    this.elevation = 0;
                    this.visualX += (this.gridX - this.visualX) * 0.2;
                    this.visualY += (this.gridY - this.visualY) * 0.2;
                }
                if (this.mt > 0) this.mt--;
                if ((this.dancing || (this.id === myUserId && isDancingLocal)) && !this.sitting) {
                    this.danceOffset = Math.abs(Math.sin(Date.now()/100)) * 10;
                } else {
                    this.danceOffset = Math.sin(Date.now()/300) * 2;
                }
            }
            draw(ctx) {
                if(this.room !== currentRoom) return; 

                const s = gridToScreen(this.visualX, this.visualY);
                let dx = s.x; let dy = s.y - TILE_H - this.danceOffset - (this.elevation || 0);
                if (this.sitting) dy += 10;
                if (this.inPool && !this.diving) dy += 10; 

                if(!this.elevation) { ctx.fillStyle = 'rgba(0,0,0,0.4)'; ctx.beginPath(); ctx.ellipse(s.x, s.y - 10, 14, 7, 0, 0, Math.PI*2); ctx.fill(); }
                if (this.diving) ctx.globalAlpha = 0.4;
                
                this.drawBody(ctx, dx, dy);
                this.drawAcc(ctx, dx, dy);
                ctx.globalAlpha = 1.0; 

                if (this.inPool && !this.diving) {
                    ctx.strokeStyle = 'rgba(200,255,255,0.5)';
                    ctx.beginPath(); ctx.ellipse(dx, dy+12, 16, 8, 0, 0, Math.PI*2); ctx.stroke();
                }

                if(this.isAdmin) { 
                    ctx.globalCompositeOperation = 'lighter'; ctx.fillStyle = 'rgba(255,0,0,0.3)'; ctx.beginPath(); ctx.arc(dx, dy-20, 20, 0, Math.PI*2); ctx.fill(); ctx.globalCompositeOperation = 'source-over';
                }

                if(this.musicId) {
                    const bx = dx - 15; const by = dy - 5; const beat = Math.abs(Math.sin(Date.now()/200))*2;
                    ctx.fillStyle = '#222'; ctx.fillRect(bx, by-beat, 14, 10);
                }
                ctx.font = "bold 9px Roboto"; ctx.fillStyle = this.isAdmin ? "#ffaaaa" : "#fff"; ctx.textAlign = "center";
                ctx.strokeStyle = "rgba(0,0,0,0.8)"; ctx.lineWidth = 2;
                ctx.strokeText(this.nick.toUpperCase(), dx, dy - 22); ctx.fillText(this.nick.toUpperCase(), dx, dy - 22);
                
                if(this.drink) { const hx = dx+18; const hy = dy; ctx.fillStyle='#fff'; ctx.fillRect(hx, hy, 6, 10); ctx.fillStyle=this.drink==='beer'?'#fc0':'#0ff'; ctx.fillRect(hx+1, hy+1, 4, 8); }
                if (this.msg && this.mt > 0) drawBubble(ctx, dx, dy - 40, this.msg);
            }
            drawBody(ctx, x, y) {
                let fill = this.skin.startsWith('#') ? this.skin : '#fcbcb8';
                if(this.skin === 'alien') fill = '#0f0'; if(this.skin === 'gold') fill = '#fc0'; if(this.skin === 'latex') fill = '#111';
                ctx.fillStyle = fill; ctx.strokeStyle = this.id === myUserId ? '#0ff' : 'rgba(0,0,0,0.5)'; ctx.lineWidth = this.id === myUserId ? 2 : 1;
                ctx.beginPath(); ctx.arc(x, y-10, 12, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                ctx.beginPath(); ctx.arc(x-9, y, 15, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                ctx.beginPath(); ctx.arc(x+9, y, 15, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                if(this.skin==='latex') { ctx.fillStyle='rgba(255,255,255,0.6)'; ctx.beginPath(); ctx.arc(x-12, y-6, 3, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(x+6, y-6, 3, 0, Math.PI*2); ctx.fill(); }
            }
            drawAcc(ctx, x, y) {
                if (this.acc === 'tanga') { ctx.fillStyle = '#ff00ff'; ctx.beginPath(); ctx.moveTo(x-20, y); ctx.lineTo(x, y+24); ctx.lineTo(x+20, y); ctx.quadraticCurveTo(x, y+10, x-20, y); ctx.fill(); }
                if (this.acc === 'fio') { ctx.strokeStyle = '#00ff00'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(x-22, y-5); ctx.lineTo(x, y+20); ctx.lineTo(x+22, y-5); ctx.stroke(); }
                if (this.acc === 'wings') { ctx.strokeStyle = '#00ffff'; ctx.lineWidth = 2; ctx.globalAlpha = 0.6; ctx.beginPath(); ctx.moveTo(x, y-10); ctx.quadraticCurveTo(x-40, y-40, x-25, y+10); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y-10); ctx.quadraticCurveTo(x+40, y-40, x+25, y+10); ctx.stroke(); ctx.globalAlpha = 1; }
            }
        }

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
        window.onresize = resize; resize();

        function drawPrism(x, y, w, h, z, cTop, cSide) {
            ctx.fillStyle = cTop; ctx.beginPath(); ctx.moveTo(x, y-z); ctx.lineTo(x+w/2, y-z+h/2); ctx.lineTo(x, y-z+h); ctx.lineTo(x-w/2, y-z+h/2); ctx.fill();
            ctx.fillStyle = cSide; ctx.beginPath(); ctx.moveTo(x+w/2, y-z+h/2); ctx.lineTo(x+w/2, y+h/2); ctx.lineTo(x, y+h); ctx.lineTo(x, y-z+h); ctx.fill();
            ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.beginPath(); ctx.moveTo(x-w/2, y-z+h/2); ctx.lineTo(x-w/2, y+h/2); ctx.lineTo(x, y+h); ctx.lineTo(x, y-z+h); ctx.fill();
        }

        function drawNeonBar(x, y, type) {
            if (type === T.BAR_COUNTER) {
                drawPrism(x, y, TILE_W, TILE_H, 25, '#111', '#000');
                ctx.globalCompositeOperation = 'lighter'; ctx.strokeStyle = `hsl(${discoTick%360}, 100%, 50%)`; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(x-30, y-20); ctx.lineTo(x+30, y-20); ctx.stroke(); ctx.globalCompositeOperation = 'source-over';
            }
            if (type === T.BAR_SHELF) {
                drawPrism(x, y, TILE_W, TILE_H, 50, '#221111', '#110a0a');
                for(let i=0; i<4; i++) { ctx.fillStyle = `hsl(${(i*90 + discoTick)%360}, 100%, 60%)`; ctx.fillRect(x - 20 + i*10, y - 35, 6, 12); }
            }
        }

        function draw() {
            requestAnimationFrame(draw);
            if (!gameReady) return; // Prevent render crash

            discoTick++;
            if(myUserId && players[myUserId]) {
                const me = players[myUserId];
                const playerIsoX = (me.visualX - me.visualY) * (TILE_W/2);
                const playerIsoY = (me.visualX + me.visualY) * (TILE_H/2);
                offset.x += ((canvas.width/2 - playerIsoX) - offset.x) * 0.1;
                offset.y += ((canvas.height/2 - playerIsoY) - offset.y) * 0.1;
            } else { 
                offset.x = canvas.width / 2; offset.y = (canvas.height / 2) - (MAP_SIZE*TILE_H)/4; 
            }

            ctx.fillStyle = '#050510'; ctx.fillRect(0,0,canvas.width, canvas.height);

            // Draw Map
            for(let i = 0; i < MAP_SIZE * 2; i++) {
                for(let j = 0; j <= i; j++) {
                    const x = j; const y = i - j;
                    if(x >= 0 && x < MAP_SIZE && y >= 0 && y < MAP_SIZE) drawTile(x, y);
                }
            }
            
            // Draw Players (Only current room)
            const sorted = Object.values(players).filter(p=>p.room===currentRoom).sort((a,b) => a.visualY - b.visualY);
            sorted.forEach(p => { 
                if(p) { // Check player exists
                    p.update(); 
                    p.draw(ctx); 
                }
            });

            // Particles
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i]; p.x += p.vx; p.y += p.vy; p.life--;
                if(p.scale) ctx.font = `${16 * p.scale}px Arial`; else ctx.font = "16px Arial";
                ctx.fillStyle = p.c; ctx.fillText(p.char, p.x, p.y);
                if(p.life<=0) particles.splice(i,1);
            }

            if(motelMode && currentRoom !== 'lobby') { ctx.fillStyle = 'rgba(255, 0, 50, 0.15)'; ctx.fillRect(0,0,canvas.width,canvas.height); }
        }

        function drawTile(x, y) {
            const t = map[y][x];
            const p = gridToScreen(x, y);
            if (p.x < -100 || p.x > canvas.width + 100 || p.y < -100 || p.y > canvas.height + 100) return;

            if (t === T.BAR_COUNTER || t === T.BAR_SHELF) { drawPrism(p.x, p.y, TILE_W, TILE_H, 0, C.woodA, C.woodB); drawNeonBar(p.x, p.y, t); return; }
            if (t === T.PLANT) { drawPrism(p.x, p.y, TILE_W, TILE_H, 0, C.lobbyA, C.lobbyB); /* Plant logic */ return; }

            if (t >= 10 && t < 20 && t !== T.POOL_WATER && t !== T.RUG_RED && t !== T.JACUZZI) {
                drawPrism(p.x, p.y, TILE_W, TILE_H, 80, C.wallTop, C.wallSide); return;
            }

            let c = C.lobbyA;
            if(t===T.FLOOR_LOBBY) c = (x+y)%2===0 ? C.lobbyA : C.lobbyB;
            if(t===T.FLOOR_WOOD) c = (x+y)%2===0 ? C.woodA : C.woodB;
            if(t===T.FLOOR_SUITE) c = (x+y)%2===0 ? C.suiteA : C.suiteB;
            if(t===T.FLOOR_DISCO) { if((x+y)%2===0) c = C.discoA; else c = (Math.floor(discoTick/20)+x)%3===0 ? '#5500aa' : C.discoB; }
            if(t===T.RUG_RED) c = '#aa0022';
            
            if(t===T.POOL_WATER || t===T.JACUZZI) { c = `rgba(0, 220, 255, ${0.5 + Math.sin((x+y+discoTick/10))*0.05})`; } 
            else if (t===T.FLOOR_POOL) c = C.poolTile;
            
            if(x===hoveredTile.x && y===hoveredTile.y) c = C.highlight;

            ctx.beginPath(); ctx.moveTo(p.x, p.y); ctx.lineTo(p.x+TILE_W/2, p.y+TILE_H/2); ctx.lineTo(p.x, p.y+TILE_H); ctx.lineTo(p.x-TILE_W/2, p.y+TILE_H/2);
            ctx.fillStyle = c; ctx.fill(); ctx.strokeStyle = 'rgba(255,255,255,0.05)'; ctx.stroke();

            if(t===T.DJ_BOOTH) drawPrism(p.x, p.y, TILE_W, TILE_H, 30, '#111', '#000');
            if(t===T.SEAT_BASIC) { ctx.fillStyle = '#5c1010'; ctx.beginPath(); ctx.arc(p.x, p.y+5, 8, 0, Math.PI*2); ctx.fill(); }
            if(t===T.SOFA) drawPrism(p.x, p.y, 40, 20, 10, '#aa2222', '#550000');
            if(t===T.BED) drawPrism(p.x, p.y, TILE_W, TILE_H, 5, '#cc0044', '#660022');
            if(t===T.BED_ROUND) { ctx.fillStyle='#ff0044'; ctx.beginPath(); ctx.arc(p.x, p.y, 25, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='#aa0022'; ctx.beginPath(); ctx.arc(p.x, p.y+5, 25, 0, Math.PI*2); ctx.fill(); }
        }

        function checkContext() {
            const me = players[myUserId]; if(!me) return;
            const t = map[Math.round(me.gridY)][Math.round(me.gridX)];
            const div = document.getElementById('ctx-ui'); div.innerHTML = '';

            if (me.carrying) div.appendChild(mkBtn('SOLTAR', 'arrow-down', 'red', dropPlayer));
            
            // Suite Actions
            if (currentRoom !== 'lobby') {
                div.appendChild(mkBtn('VOLTAR LOBBY', 'door-open', 'blue', () => switchRoom('lobby')));
                div.appendChild(mkBtn('LUZ VERMELHA', 'lightbulb', 'red', toggleMotelMode));
                if (t === T.BED_ROUND) div.appendChild(mkBtn('OBA OBA', 'heart', 'red', () => triggerInteract('obaoba')));
            }

            if (me.drink) div.appendChild(mkBtn('VIRAR', 'glass-martini-alt', 'drink', consumeDrink)); 
            else if (me.gridY > 18 && me.gridX < 5 && currentRoom === 'lobby') div.appendChild(mkBtn('DRINK', 'cocktail', 'drink', () => getDrink('martini')));
            
            if (t === T.POOL_WATER || t === T.JACUZZI) div.appendChild(mkBtn(me.diving ? 'EMERGIR' : 'MERGULHAR', 'water', 'blue', toggleDive));
            if (t === T.FLOOR_DISCO && !me.sitting) div.appendChild(mkBtn(isDancingLocal?'PARAR':'DAN√áAR', 'music', 'dance', toggleDance));
            if (me.sitting) div.appendChild(mkBtn('LEVANTAR', 'walking', 'drink', standUp));
        }

        function mkBtn(txt, ico, cls, fn) {
            const b = document.createElement('div'); b.className = `ctx-btn ${cls}`;
            b.innerHTML = `<i class="fas fa-${ico}"></i> ${txt}`; b.onclick = fn; return b;
        }

        window.triggerInteract = async (type) => {
            document.getElementById('interact-menu').style.display = 'none';
            if (type === 'obaoba') {
                await updateDoc(myPlayerRef, { intType: 'obaoba', lastInt: Date.now() });
                players[myUserId].playInteraction('obaoba');
                return;
            }
            if (!selectedTargetId || !myPlayerRef) return;
            if (type === 'carry') {
                await updateDoc(myPlayerRef, { carrying: selectedTargetId });
                players[myUserId].carrying = selectedTargetId; showToast("Pegou!"); checkContext(); return;
            }
            await updateDoc(myPlayerRef, { intType: type, target: selectedTargetId, lastInt: Date.now() });
            players[myUserId].playInteraction(type); showToast(`Mandou ${type}!`); selectedTargetId = null;
        };

        window.dropPlayer = async () => { if(myPlayerRef) { await updateDoc(myPlayerRef, { carrying: null }); players[myUserId].carrying = null; showToast("Soltou!"); checkContext(); }};
        
        window.sendEmote = async (emoji) => {
            document.getElementById('emote-menu').classList.remove('visible');
            if (myPlayerRef) { await updateDoc(myPlayerRef, { emote: emoji, emoteId: crypto.randomUUID(), lastActive: Date.now() }); players[myUserId].playEmote(emoji); }
        };
        window.startDJ = async () => {
            const val = document.getElementById('music-input').value;
            const regExp = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
            const match = val.match(regExp);
            if (match && match[1]) { await updateDoc(myPlayerRef, { musicId: match[1] }); showToast('Som na caixa! üéµ'); document.getElementById('music-menu').style.display='none'; }
            else showToast('Link inv√°lido!');
        };
        window.stopDJ = async () => { await updateDoc(myPlayerRef, { musicId: null }); document.getElementById('music-menu').style.display='none'; showToast('M√∫sica Parada.'); };

        window.closeMenu = () => document.getElementById('interact-menu').style.display = 'none';
        async function getDrink(type) { players[myUserId].drink = type; showToast(`Pegou ${type}!`); sendState(); checkContext(); }
        async function consumeDrink() { players[myUserId].drink = false; drunkLevel += 25; sendState(); checkContext(); }
        async function toggleDance() { isDancingLocal = !isDancingLocal; sendState(); checkContext(); }
        async function toggleDive() { const me = players[myUserId]; me.diving = !me.diving; await updateDoc(myPlayerRef, { diving: me.diving }); checkContext(); }
        async function toggleMotelMode() { motelMode = !motelMode; showToast(motelMode ? "üî• Modo Motel ON üî•" : "Luzes Normais"); }
        async function standUp() { players[myUserId].sitting = false; sendState(); checkContext(); }

        function drawBubble(ctx, x, y, text) {
            ctx.font = "bold 10px Roboto"; const w = ctx.measureText(text).width + 16;
            ctx.fillStyle = 'rgba(255,255,255,0.9)'; ctx.beginPath(); ctx.roundRect(x-w/2, y-20, w, 22, 6); ctx.fill();
            ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x-4, y-5); ctx.lineTo(x+4, y-5); ctx.fill();
            ctx.fillStyle = '#000'; ctx.textAlign = 'center'; ctx.fillText(text, x, y-6);
        }

        function handleInput(cx, cy) {
            if(!gameReady || !myUserId) return; 
            if(document.activeElement.tagName==='INPUT') return;
            if(cx < 50 && cy > window.innerHeight - 50) return;
            const r = canvas.getBoundingClientRect();
            let g = screenToGrid(cx-r.left, cy-r.top);

            if (g.x>=0 && g.x<MAP_SIZE && g.y>=0 && g.y<MAP_SIZE) {
                let clickedPlayer = null;
                Object.values(players).filter(p=>p.room===currentRoom).forEach(p => { 
                    if (p.id !== myUserId && Math.round(p.visualX) === g.x && Math.round(p.visualY) === g.y) clickedPlayer = p; 
                });

                if (clickedPlayer) {
                    selectedTargetId = clickedPlayer.id;
                    const menu = document.getElementById('interact-menu');
                    menu.style.display = 'flex'; menu.style.left = cx+'px'; menu.style.top = cy+'px';
                } else {
                    const me = players[myUserId];
                    if(!me) return; 
                    
                    me.gridX = g.x; me.gridY = g.y;
                    const t = map[g.y][g.x];
                    if (t < 2 && isDancingLocal) isDancingLocal = false;
                    me.sitting = (t >= 20); 
                    sendState(); checkContext();
                }
            }
        }
        
        canvas.addEventListener('mousedown', e => handleInput(e.clientX, e.clientY));
        canvas.addEventListener('touchstart', e => { if(e.target.tagName!=='BUTTON'){e.preventDefault(); handleInput(e.touches[0].clientX, e.touches[0].clientY);} }, {passive:false});
        canvas.addEventListener('mousemove', e => {
            const r = canvas.getBoundingClientRect();
            hoveredTile = screenToGrid(e.clientX-r.left, e.clientY-r.top);
            const t = map[hoveredTile.y]?.[hoveredTile.x];
            canvas.style.cursor = (t!==undefined) ? 'pointer' : 'default'; 
        });

        function showToast(m){const t=document.getElementById('toast');t.innerText=m;t.style.display='block';setTimeout(()=>t.style.display='none',3000);}
        
        const tmp = {s:'#fcbcb8', a:'none', n: ''};
        ['#fcbcb8', '#a56e50', '#3d231a', 'latex', 'alien', 'gold'].forEach(c => {
            const b=document.createElement('div'); b.className='skin-opt'; b.style.background = c==='latex'?'#000':(c==='alien'?'#0f0':c);
            b.onclick=()=>{ tmp.s=c; document.querySelectorAll('.skin-opt').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); };
            document.getElementById('skin-grid').appendChild(b);
        });
        ['none', 'tanga', 'fio', 'harness', 'wings'].forEach(a => {
            const b=document.createElement('div'); b.className='acc-btn'; b.innerText=a.toUpperCase();
            b.onclick=()=>{ tmp.a=a; document.querySelectorAll('.acc-btn').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); };
            document.getElementById('acc-grid').appendChild(b);
        });
        document.getElementById('btn-save').onclick = async () => {
            const nameInput = document.getElementById('input-name').value.trim() || 'Guest';
            if(myPlayerRef) await updateDoc(myPlayerRef, { skin: tmp.s, acc: tmp.a, nick: nameInput });
            document.getElementById('custom-panel').classList.remove('open'); showToast('Salvo!');
        };
        draw();
    </script>
</body>
</html>

